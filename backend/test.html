<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordle Game Test Client</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent: #4CAF50;
            --error: #f44336;
            --sent: #2196F3;
            --received: #FF9800;
        }
        body { font-family: monospace; background: var(--bg-color); color: var(--text-color); padding: 20px; display: flex; gap: 20px; height: 90vh; }
        h2 { margin-top: 0; }
        
        /* Layout */
        .panel { background: #2d2d2d; padding: 15px; border-radius: 8px; flex: 1; display: flex; flex-direction: column; }
        .left-panel { flex: 0 0 400px; gap: 15px; overflow-y: auto; }
        .right-panel { flex: 1; }

        /* Controls */
        .control-group { border: 1px solid #444; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .control-group h3 { margin: 0 0 10px 0; font-size: 1.1em; color: var(--accent); }
        input, button { padding: 8px; background: #3d3d3d; border: 1px solid #555; color: white; border-radius: 4px; width: 100%; box-sizing: border-box; margin-bottom: 5px; font-family: monospace; }
        button { cursor: pointer; background: #444; font-weight: bold; }
        button:hover { background: #555; }
        button.primary { background: var(--accent); color: black; }
        
        /* Logs */
        #log-container { flex: 1; overflow-y: auto; background: #111; border: 1px solid #333; padding: 10px; font-size: 12px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-sent { color: var(--sent); }
        .log-received { color: var(--received); }
        .log-error { color: var(--error); }
        .timestamp { color: #666; margin-right: 10px; }

        /* State Display */
        .state-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 2px;}
        .state-label { color: #888; }
        .state-value { font-weight: bold; color: var(--accent); }

        /* Simple Board Viz */
        .guess-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .letter-box { width: 30px; height: 30px; border: 1px solid #555; display: flex; align-items: center; justify-content: center; font-weight: bold; text-transform: uppercase; }
        .green { background-color: green; color: white; }
        .yellow { background-color: goldenrod; color: black; }
        .gray { background-color: #555; color: white; }

    </style>
</head>
<body>

    <div class="panel left-panel">
        <h2>Game Controls</h2>
        
        <div class="control-group">
            <h3>1. Connection</h3>
            <button onclick="connect()" id="btn-connect" class="primary">Connect to WebSocket</button>
            <button onclick="disconnect()" id="btn-disconnect" style="display:none;">Disconnect</button>
            <div style="margin-top:5px; font-size: 0.9em;">
                Status: <span id="ws-status" style="color: red">Disconnected</span>
            </div>
        </div>

        <div class="control-group">
            <h3>My Identity</h3>
            <div class="state-row">
                <span class="state-label">Player ID:</span>
                <span class="state-value" id="display-pid">Unknown</span>
            </div>
            <div class="state-row">
                <span class="state-label">Active Game ID:</span>
                <span class="state-value" id="display-gid">None</span>
            </div>
        </div>

        <div class="control-group">
            <h3>2. Lobby</h3>
            <button onclick="sendCreateGame()">Create New Game</button>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="input-join-gid" placeholder="Game ID to Join">
                <button onclick="sendJoinGame()" style="width: auto;">Join</button>
            </div>
        </div>

        <div class="control-group">
            <h3>3. Gameplay</h3>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="input-guess" placeholder="5 Letter Word" maxlength="5">
                <button onclick="sendGuess()" class="primary" style="width: auto;">Guess</button>
            </div>
            <button onclick="sendNewGame()">Reset/New Round</button>
            <button onclick="sendLeaveGame()" style="background: #f44336; color: white; margin-top: 5px;">Leave Game</button>
        </div>
        
        <div class="control-group">
            <h3>Board Visualization</h3>
            <div class="state-row">
                <span class="state-label">Turn:</span>
                <span class="state-value" id="display-turn">---</span>
            </div>
            <div class="state-row">
                <span class="state-label">Status:</span>
                <span class="state-value" id="display-status">---</span>
            </div>
            <div id="board-viz" style="margin-top: 10px;"></div>
        </div>
    </div>

    <div class="panel right-panel">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Event Log (JSON)</h2>
            <button onclick="clearLog()" style="width: auto; padding: 5px 10px;">Clear</button>
        </div>
        <div id="log-container"></div>
    </div>

    <script>
        let ws = null;
        let myPlayerId = null;
        let activeGameId = null;

        const statusSpan = document.getElementById('ws-status');
        const btnConnect = document.getElementById('btn-connect');
        const btnDisconnect = document.getElementById('btn-disconnect');

        // --- WebSocket Handling ---

        function connect() {
            if (ws) return;

            try {
                // Connecting to the address defined in the Rust server
                ws = new WebSocket("ws://localhost:5905/ws");

                ws.onopen = () => {
                    statusSpan.textContent = "Connected";
                    statusSpan.style.color = "#4CAF50";
                    btnConnect.style.display = 'none';
                    btnDisconnect.style.display = 'block';
                    addLog("System", "Connection established");
                };

                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addLog("Received", data);
                        handleServerMessage(data);
                    } catch (e) {
                        addLog("Error", "Failed to parse JSON: " + event.data);
                    }
                };

                ws.onclose = () => {
                    statusSpan.textContent = "Disconnected";
                    statusSpan.style.color = "red";
                    btnConnect.style.display = 'block';
                    btnDisconnect.style.display = 'none';
                    ws = null;
                    addLog("System", "Connection closed");
                };

                ws.onerror = (err) => {
                    addLog("Error", "WebSocket Error occurred");
                    console.error(err);
                };

            } catch (e) {
                alert("Could not connect: " + e);
            }
        }

        function disconnect() {
            if (ws) ws.close();
        }

        function send(data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("Not connected!");
                return;
            }
            
            // Inject current playerId if required and missing
            if (!data.playerId && myPlayerId) {
                data.playerId = myPlayerId;
            }

            addLog("Sent", data);
            ws.send(JSON.stringify(data));
        }

        // --- Logic Handlers ---

        function handleServerMessage(data) {
            // 1. Handle Initial Welcome
            if (data.action === "welcome") {
                myPlayerId = data.playerId;
                document.getElementById('display-pid').textContent = myPlayerId;
            }

            // 2. Handle Game Creation
            if (data.action === "createdStatus") {
                activeGameId = data.gameId;
                updateGameIdDisplay();
            }

            // 3. Handle Board Updates (Join, Update, NewGame)
            if (data.boardState) {
                renderBoard(data.boardState);
            }
        }

        function updateGameIdDisplay() {
            document.getElementById('display-gid').textContent = activeGameId || "None";
            document.getElementById('input-join-gid').value = activeGameId || "";
        }

        function renderBoard(state) {
            const container = document.getElementById('board-viz');
            container.innerHTML = '';

            // Update textual status
            document.getElementById('display-turn').textContent = 
                (state.currentTurn === myPlayerId) ? "YOU" : state.currentTurn;
            
            let statusText = "Unknown";
            if(state.gameStatus === "inProgress") statusText = "In Progress";
            else if(state.gameStatus === "won") statusText = "WON! ðŸŽ‰";
            else if(state.gameStatus === "lost") statusText = "Game Over ðŸ’€";
            else if(state.gameStatus === "aborted") statusText = "Aborted";
            
            document.getElementById('display-status').textContent = statusText;

            // Draw Guesses
            state.guesses.forEach(guess => {
                const row = document.createElement('div');
                row.className = 'guess-row';
                
                const letters = guess.word.split('');
                letters.forEach((char, idx) => {
                    const box = document.createElement('div');
                    box.className = 'letter-box';
                    box.textContent = char;

                    // Map Rust enum colors to CSS classes
                    const colorEnum = guess.status[idx];
                    if (colorEnum === "green") box.classList.add('green');
                    else if (colorEnum === "yellow") box.classList.add('yellow');
                    else box.classList.add('gray');

                    row.appendChild(box);
                });
                container.appendChild(row);
            });
        }

        // --- User Actions ---

        function sendCreateGame() {
            send({
                action: "createGame",
                playerId: myPlayerId
            });
        }

        function sendJoinGame() {
            const gid = document.getElementById('input-join-gid').value.trim();
            if (!gid) return alert("Enter a Game ID");
            
            activeGameId = gid; // Assume success for UI, server will error if invalid
            updateGameIdDisplay();

            send({
                action: "joinGame",
                gameId: gid,
                playerId: myPlayerId
            });
        }

        function sendGuess() {
            const word = document.getElementById('input-guess').value.trim();
            if (!activeGameId) return alert("Join a game first");
            if (word.length !== 5) return alert("Word must be 5 letters");

            send({
                action: "guessWord",
                gameId: activeGameId,
                playerId: myPlayerId,
                word: word
            });
            
            document.getElementById('input-guess').value = ''; // Clear input
        }

        function sendNewGame() {
            if (!activeGameId) return alert("No active game");
            send({
                action: "newGame",
                gameId: activeGameId,
                playerId: myPlayerId
            });
        }

        function sendLeaveGame() {
             if (!activeGameId) return alert("No active game");
             send({
                action: "disconnectPlayer",
                gameId: activeGameId,
                playerId: myPlayerId
             });
             // Reset local UI state
             activeGameId = null;
             updateGameIdDisplay();
             document.getElementById('board-viz').innerHTML = '<i>Left game</i>';
        }

        // --- Logging Helper ---

        function addLog(type, msg) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString();
            let typeClass = "";
            if (type === "Sent") typeClass = "log-sent";
            if (type === "Received") typeClass = "log-received";
            if (type === "Error") typeClass = "log-error";

            // Prettify JSON if it's an object
            const content = (typeof msg === 'object') ? JSON.stringify(msg, null, 2) : msg;

            entry.innerHTML = `
                <span class="timestamp">[${time}]</span>
                <strong class="${typeClass}">${type}:</strong>
                <pre style="margin: 5px 0 0 0; white-space: pre-wrap;">${content}</pre>
            `;
            
            container.insertBefore(entry, container.firstChild);
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }
    </script>
</body>
</html>
